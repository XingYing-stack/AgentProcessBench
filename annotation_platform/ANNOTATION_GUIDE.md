# AgentProcessBench 标注手册（v1.1）

本手册用于 **AgentProcessBench（工具使用场景的 Process Reward / 步骤级监督）** 的人工标注。本基准关注 **Tool-Use Agent 在多步交互中的过程质量**，重点看：

- 工具选择与参数是否合理
- 是否正确理解并利用工具返回
- 是否遵循系统与任务约束（policy / format / state）
- 是否允许真实的 **“做错 → 纠错 → 继续”** 行为模式

核心判断标准：

> 这个步骤是否让任务“更接近被正确完成”？（而不是“看起来像在努力”。）

---

## 0. 与标注平台一致的“Step”定义（重要）

为避免歧义，本手册的 step 定义 **严格对齐当前 `annotation_platform` 的实现**（你在网页上看到的每个可打分单元）：

- **一个 Step = 一条 `role="assistant"` 的消息（assistant message）**
- 平台只会让你对这些 assistant message 打 `+ / 0 / -`
- `role="user"` 与 `role="tool"` **不打标签**，但它们是判断正误的关键证据

> 说明：即使某条 assistant message 内包含多个 `tool_calls`，在当前平台里也 **仍然只打一个标签**（对整条 message 的“净贡献”评价）。

---

## 1. 标注目标与产出

给定一条完整轨迹（用户任务、工具定义、模型输出、工具返回等），你的任务是：

1) **对每条 assistant message 打标签（+1 / 0 / -1）**  
2) **对“最终结果”再单独打一个标签（+1 / 0 / -1）**

平台层面的强约束（否则无法保存）：

- **每条 assistant message 必须都有标签**
- **“最终结果标注”必须点击过（touched）**

输出会落盘到 SQLite，并导出到 JSONL（append-only），用于后续训练/统计。

---

## 2. 标签体系（三分类，目标导向）

### 2.1 Positive（+1，正）

该 step **正确、合理，并对完成任务有实质性推进作用**。

常见情形：
- 选择了**正确的工具**，调用时机合理
- 工具参数满足 schema 与任务约束（字段/类型/格式/范围/先决条件）
- 正确理解并利用 tool 返回（引用证据、更新状态、修正计划）
- 必要澄清（不问会高风险出错/无法继续）
- **有效纠错**：识别并修正前序错误，使轨迹回到正确方向
- **交叉验证**：如果“重复”是有目的的核验/交叉验证，并且确实补齐关键证据或纠正了前序错误（比如换来源验证同一事实，或复现错误以定位原因），应该标记为Positive。

判断口径：
> 保留这个 step，会让任务更容易被正确完成。

---

### 2.2 Negative（-1，负）

该 step **引入错误、偏离目标或破坏任务完成的可能性**。

常见情形：
- 工具选择明显错误；或参数错误导致调用无效/越权/违反 schema
- **误读 tool 返回**，或把 tool 返回“想象成”自己需要的内容
- **编造/臆断**：无证据确定性断言、伪造引用、伪造 tool 结果
- **冗余**：明显重复且无新增信息（同工具同参数/同 query、无策略变化），或已经有足够证据仍反复做；导致浪费步骤、错过关键动作、在错误前提上重复推进
- 建立在错误前提上继续推进（“错上加错”），且无核验/回退/纠错
- 违反系统/任务约束（policy/格式/状态机；必须确认却直接执行）
- 明显跑题导致主任务丢失

判断口径：
> 这个 step 让任务更难完成，甚至把轨迹推向失败。

---

### 2.3 Neutral（0，中）

该 step **影响不明确、贡献很小，或证据不足以判断正负**。

常见情形：
- 合理探索/尝试，但尚未产出有效信息（比如一次检索不命中）
- 工具失败源于环境/外部原因（404、权限、网络、文件不存在等），且并非明显参数错误
- 内容基本正确但信息量很低、略冗余，未明显伤害任务

判定原则：
- **不确定**优先 Neutral  
- 但“无证据硬编/强猜/误读返回”通常是 **Negative**

---

## 3. “最终结果标注”的定义（与步骤标签的关系）

平台顶部的“最终结果标注”用于评价 **最终交付物/最终答案** 的质量，不等同于“最后一条 assistant message 的标签”。

建议口径：

- **最终结果 +1**：最终答案与 ground truth 一致（或在轨迹证据下可判定正确），且满足输出格式/约束
- **最终结果 -1**：最终答案错误、格式不合规、或结论与证据冲突
- **最终结果 0**：缺少足够证据判断对错，或任务本身开放且轨迹证据不足

冲突如何处理（常见）：
- 过程多数步骤合理，但最后答案错：步骤可以多为 +1 / 0，但**最终结果应为 -1**
- 过程有明显试错，但成功纠错并给出正确答案：中间可有 -1，纠错后可回到 +1，**最终结果为 +1**

---

## 4. 错误传播与“可纠错”原则（非常重要）

### 4.1 错误传播规则

如果某一步引入错误事实/错误状态，后续步骤 **完全建立在错误前提上继续推进**，并且 **没有**核验/回退/纠错动作：

- 后续步骤应标为 **Negative (-1)**

### 4.2 纠错例外（允许“回到正确轨道”）

若后续步骤明确在做以下任一行为，可不按错误传播直接判 Negative：

- 指出之前错误点（事实/参数/工具选择/约束理解）
- 重新检索、对齐证据、回退状态、替换工具/参数进行验证
- 基于 tool 报错信息进行修正

标注建议：
- **有效纠错（纠回来了）** → Positive
- **尝试纠错但信息仍不足** → Neutral
- **表面纠错，或者实际上继续错** → Negative

---

## 5. 工具失败/异常（统一口径）

当工具调用失败（404/权限/无结果/超时/解析失败等）时：

- **第一次合理尝试失败**：通常 Neutral
- **基于失败信息调整策略（换 query/换工具/换证据源/降级方案）**：Positive
- **重复同样错误（同参数/同 query/无变化）**：从 Neutral 逐步转 Negative（视重复与损害程度）
- **失败后硬编答案或伪造证据**：Negative

---

## 6. 四个数据源的标注要点

### 6.1 HotpotQA（文本问答 + 检索）

关注：
- 检索 query 是否对题、是否指向正确实体
- 是否基于检索证据得出结论（证据链是否闭合）
- 最终答案是否与 ground truth 一致，且满足要求格式（如 `<answer>...</answer>`）

---

### 6.2 GAIA-Text Only（多步检索 / 阅读）

常见工具：`search`、`fetch_url`、`read_file`（以样本的 tool 文档为准）

关注：
- 是否逐步缩小问题空间、抓到关键证据
- 是否正确处理页面结构/长文档（是否定位到与问题相关段落）
- 最终答案是否满足格式/约束（数字/单位/区分大小写/特定包装标签等）

---

### 6.3 τ²-bench（真实业务流程模拟）

关注重点：**合规与流程**（通常体现在 system message 或 tool 文档里）

重点检查：
- 是否按 policy 行事（哪些能做/不能做）
- 必要时是否确认用户意图（尤其是不可逆操作、退款/赔付、取消/改签等）
- 是否合理升级/转人工（何时是任务确实需要 -> Positive，何时是模型选择逃避 -> Negative）

---

### 6.4 BFCL multi-turn（函数组合 / 状态环境）

关注：
- 是否满足工具先决条件（顺序、状态机）
- 参数名/类型/取值范围是否正确
- 是否根据错误提示进行修正

---
## 7. Ground Truth / Reward Info 字段解读（按数据集划分）

平台左栏中的 **Ground Truth / Reward Info** 用于为标注员提供“可核验的参考信息”。  
这些字段的目的不是替代人工判断，而是帮助你**快速理解任务期望、核对最终结果、定位可能的违规或失败原因**。

---

### 总体使用原则（请先阅读）

- **人工标注优先**：你的判断永远高于任何自动 reward。
- **最终结果判断**：
  - 优先参考 `ground_truth`
  - `reward_info.reward` 只是自动评测提示，可能不稳定、可能为 0、也可能漏判。
- **步骤级标注**：
  - 始终围绕“该步骤是否推进正确完成任务”。
  - `ground_truth / reward_info` 主要用于判断：
    - 最终是否正确
    - 是否违反明确约束 / 流程 / policy

⚠️ **注意**：  
- `reward = 0` ≠ “一定错误”  
- `reward = 1` ≠ “一定正确”  

---

## 7. Ground Truth / Reward Info 字段解读（按数据集划分）

### 7.1 HotpotQA

#### 字段说明

- **`ground_truth.target`**
  - 类型：`List[str]`
  - 含义：可接受的最终答案集合（通常只有一个）
  - 用途：判断最终答案是否正确

- **`reward_info.reward`**
  - 自动 judge 给出的提示性结果
  - `reward = 0` 常表示“不确定 / 无法判定”

#### 标注建议

- **最终结果**
  - 最终答案不在 `target` 中 → 最终结果一般标 `-1`
  - 在 `target` 中 → 最终结果可标 `+1`
- **步骤级**
  - 检索是否对题、是否找到关键证据
  - 是否“无证据硬编”
- 即使最终答案错，合理的检索步骤仍可为 `+1`

---

### 7.2 GAIA-Text Only

#### 字段说明

- **`ground_truth.answer`**
  - 唯一最终正确答案（字符串或数字字符串）

- **`ground_truth.Steps / Tools / Number of steps`**
  - 参考性解题路径说明
  - ⚠️ 不是硬约束，不要求模型复刻

- **`reward_info.reward`**
  - 自动评测提示，仅供参考

#### 标注建议

- **最终结果**
  - 与 `ground_truth.answer` 一致 → 一般标 `+1`
  - 不一致 → 一般标 `-1`
- **过程**
  - 关注证据链是否合理
  - 工具返回结果可能并非完美，模型需要根据工具返回结果多轮迭代，根据错误工具直接回答标`-1`
- 不因模型的运行路径和参考路径不同而直接判错

---

### 7.3 τ²-bench（airline / retail / telecom）

#### 字段说明

- **`ground_truth.nl_assertions`**
  - 自然语言层面的关键业务约束
  - 例如：
    - “应拒绝取消航班”
    - “不得承诺退款”
    - “必须向用户解释原因”

- **`ground_truth.actions`**
  - 参考答案的执行步骤

- **`communicate_info`**
  - 在某些关键节点，assistant 应该向用户明确传达哪些信息或立场。


- **`reward_info.reward_breakdown`**
  - 自动检查的分项结果（用于快速定位问题）

#### 标注建议

- 若 assistant 行为明显违背 `nl_assertions`
  → 相关步骤与最终结果倾向 `-1`
- 若遵循断言并合理推进流程
  → 步骤与最终结果可为 `+1`
- τ² 任务不一定有“答案句”，合规流程本身就是成功

---

### 7.4 BFCL multi-turn

#### 字段说明

- **`ground_truth`**
  - 多轮期望目标序列
  - 每一轮包含若干关键工具调用字符串
  - 顺序与关键动作重要，但不要求逐字一致

- **`reward_info.info`**
  - 验证器输出（如 `valid`、`error_type`、`expected_tool_names` 等）
  - 用于定位失败原因

#### 标注建议

- **最终结果**
  - 回合数不足、关键动作缺失、提前终止 → 一般标 `-1`
- **步骤级**
  - 工具名/参数明显错误 → `-1`
  - 根据报错修正并回到正确路径 → 修正步可为 `+1`
- 合理探索性报错可为 `0`

---

## 8. 带标签示例（assistant message 粒度）

说明：
- 下表中的 `S1/S2/...` 都对应 **一条 `role="assistant"` 消息**
- `role="tool"` 的返回不打分，但你必须结合它判断相邻步骤的正误

### A. HotpotQA 示例 1（正确链路）

**任务**：Are the Laleli Mosque and Esma Sultan Mansion located in the same neighborhood?  
**目标答案**：No

| Step | 行为摘要 | 标签 | 原因 |
|---|---|---|---|
| S1 | search 查询 Laleli Mosque 位置 | Positive | 拿到关键地点信息 |
| S2 | search 查询 Esma Sultan Mansion 位置 | Positive | 获取第二实体证据 |
| S3 | 输出 `<answer>No</answer>` | Positive | 基于证据，结论正确 |

### B. HotpotQA 示例 2（证据不匹配导致错误）

| Step | 行为摘要 | 标签 | 原因 |
|---|---|---|---|
| S1 | search，结果指向错误大学 | Neutral | 探索性但跑偏 |
| S2 | 再次 search，仍未修正实体 | Neutral | 重复且未纠错 |
| S3 | 输出错误答案（与证据不一致） | Negative | 结论与证据不一致 |

### C. GAIA 示例（失败后纠错，最终正确）

| Step | 行为摘要 | 标签 | 原因 |
|---|---|---|---|
| S1 | search 关键实体/线索 | Positive | 检索方向正确 |
| S2 | fetch_url 返回 404 | Neutral | 合理尝试但失败（非明显乱填） |
| S3 | 改用其他检索/证据源 | Positive | 有效纠错 |
| S4 | fetch_url/read_file 得到关键证据 | Positive | 关键信息 |
| S5 | 输出最终答案（格式符合要求） | Positive | 与 ground truth 一致 |

### D. GAIA 示例（过程合理，结论错误）

| Step | 行为摘要 | 标签 | 原因 |
|---|---|---|---|
| S1–S4 | 多次检索并定位文档证据 | Positive | 过程推进合理 |
| S5 | 输出最终答案错误 | Negative | 与 ground truth 不一致 |

### E. τ²-bench 示例（合规拒绝 + 合理升级）

| Step | 行为摘要 | 标签 | 原因 |
|---|---|---|---|
| S1 | 查询订单/状态 | Positive | 获取关键事实 |
| S2 | 解释政策限制/合规边界 | Positive | 合规解释 |
| S3 | 按流程升级/转人工 | Positive | 合理升级 |

### F. τ²-bench 示例（跑题 + 编造）

| Step | 行为摘要 | 标签 | 原因 |
|---|---|---|---|
| S1–S3 | 初始围绕主任务推进 | Positive | 推进主任务 |
| S4–S6 | 偏离主任务且未回到流程 | Negative | 丢失主任务 |
| S7 | 编造/混乱补偿或政策 | Negative | 与约束不一致 |
| S8 | 直接转人工逃避问题 | Negative | 未合规处理/未纠错 |

### G. BFCL 示例（参数错误后纠正）

| Step | 行为摘要 | 标签 | 原因 |
|---|---|---|---|
| S1 | 定位资源/读取文档 | Positive | 定位正确 |
| S2 | 工具调用参数错误 → 报错 | Negative | 违反 schema/先决条件 |
| S3 | 根据报错修正参数重试 | Positive | 有效纠错 |
| S4 | 后续调用完成任务 | Positive | 推进并完成 |

### H. BFCL 示例（忽视先决条件 + 多余动作）

| Step | 行为摘要 | 标签 | 原因 |
|---|---|---|---|
| S1 | 正确的必要工具调用 | Positive | 推进主任务 |
| S2 | 忽视先决条件直接调用 → 报错/无效 | Negative | 先决条件错误 |
| S3 | 补齐先决条件并重试 | Positive | 纠错 |
| S4 | 与任务无关的额外动作 | Negative | 破坏状态/跑题 |



## 8. 标注操作建议

1. 先通读用户任务，明确“最终交付物”
2. 逐 step 对照 tool 返回判断
3. 以“是否推进完成任务”为唯一核心标准
4. 不确定时优先标 **Neutral**
5. 避免引入外部知识，仅基于轨迹本身判断

---

**本手册为 AgentProcessBench 官方标注规范 v1.1**  
